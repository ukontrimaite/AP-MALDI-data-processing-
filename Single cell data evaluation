# Load necessary libraries
library(Cardinal)
library(viridis)
library(openxlsx)  # For writing to Excel
library(ggplot2)   # For plotting
library(moments)   # For skewness
library(nortest)   # For normality tests

# Load the file
path_processed <-"/Users/unek/Desktop/gin8_positive.imzml"
print(path_processed)

# Load the processed imzML file
msa_peaks <- readMSIData(path_processed)
msa <- msa_peaks

# Data pre-processing 
msa_pre <- normalize(msa, method="tic")
msa_pre <- reduceBaseline(msa_pre, method="locmin")
process(msa_pre)
msa_peaks <- peakPick(msa_pre, method="mad", SNR=2)
process(msa_peaks)
mse_peaks <- peakAlign(msa_peaks, tolerance=5, units="ppm")
mse <- mse_peaks

# Optional - Data pre-processing step 
mse_filt <- subsetFeatures(mse_peaks, freq > 0.1)
mse <- mse_filt

# ----------------------------
# Normality Assessment (Raw Data)
# ----------------------------

# 1) Compute total-ion intensities per pixel
#    i.e., sum intensities across ALL m/z for each pixel.
msi_matrix <- as.matrix(intensity(mse))

# Flatten the entire msi_matrix into a single vector
all_values <- as.vector(msi_matrix)

# Data frame for plotting
df_all <- data.frame(Intensity = all_values)

# Histogram of all intensities
ggplot(df_all, aes(x = Intensity)) +
  geom_histogram(bins = 50, fill = "#9ECFFF", color = "black") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Histogram of All Intensities Across All Pixels & m/z",
    x = "Raw Intensity",
    y = "Frequency"
  )

# Q-Q Plot
qqnorm(df_all$Intensity, main = "Q-Q Plot of All Raw Intensities")
qqline(df_all$Intensity, col = "red")

# Shapiro-Wilk
shapiro_test_all <- shapiro.test(df_all$Intensity)
print(paste("Shapiro-Wilk test p-value (all intensities) =", shapiro_test_all$p.value))

# Skewness
skew_all <- skewness(df_all$Intensity, na.rm = TRUE)
print(paste("Skewness (all intensities) =", skew_all))

# Density
ggplot(df_all, aes(x = Intensity)) +
  geom_density(fill = "red", alpha = 0.3) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Density Plot of All Raw Intensities",
    x = "Intensity",
    y = "Density"
  )
