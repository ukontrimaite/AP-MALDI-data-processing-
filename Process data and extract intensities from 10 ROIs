# Load necessary libraries
library(Cardinal)
library(viridis)
library(openxlsx)  # For writing to Excel
library(ggplot2)   # For plotting
library(moments)   # For skewness
library(nortest)   # For normality tests

# Load the file
path_processed <-"/Users/unek/Desktop/gin8_positive.imzml"
print(path_processed)

# Load the processed imzML file
msa_peaks <- readMSIData(path_processed)
msa <- msa_peaks

# Data pre-processing 
msa_pre <- normalize(msa, method="tic")
msa_pre <- reduceBaseline(msa_pre, method="snip")
process(msa_pre)
msa_peaks <- peakPick(msa_pre, method="mad", SNR=3)
process(msa_peaks)
mse_peaks <- peakAlign(msa_peaks, tolerance=5, units="ppm")
mse <- mse_peaks

# Optional - Data pre-processing step 
mse_filt <- subsetFeatures(mse_peaks, freq > 0.1)
mse <- mse_filt

# ----------------------------
# ROI Extraction for 10 Cells
# ----------------------------

# Extract the coordinates data frame
coords <- coord(mse)

# Create a list to store the ROI data
roi_list <- list()

# Loop to select and name 10 ROIs
for (i in 1:10) {
  roi_name <- paste("cell", i, sep = "_")
  sampleROI <- selectROI(mse, mz=159.1236, mode="region")
  
  # Extract intensities and coordinates from the ROI
  roi_intensities <- intensity(mse)[, sampleROI]
  roi_coordinates <- coord(mse)[sampleROI, ]
  
  # Compute mean intensities for each m/z across extracted pixels
  mean_intensities <- rowMeans(roi_intensities, na.rm = TRUE)
  
  # Create a data frame with m/z and mean intensities
  roi_data <- data.frame(mz = mz(mse), Mean_Intensity = mean_intensities)
  names(roi_data)[2] <- roi_name  # Rename column to reflect cell name
  
  # Store data in the list
  roi_list[[roi_name]] <- roi_data
}

# Combine all cell data frames into a single data frame
combined_roi_data <- Reduce(function(x, y) merge(x, y, by = "mz", all = TRUE), roi_list)

# Save the combined data frame as an Excel file
output_excel_file <- "~/Documents/combined_roi_intensities.xlsx"
write.xlsx(combined_roi_data, file = output_excel_file, rowNames = FALSE)
print(paste("Excel file saved at:", output_excel_file))

# Suppose 'combined_roi_data' has columns:
#   mz, cell_1, cell_2, ..., cell_10

# 1. Convert everything EXCEPT the 'mz' column into a matrix
all_cell_means <- as.matrix(combined_roi_data[ , -1])

# 2. Flatten that matrix into a single vector
flattened_means <- as.vector(all_cell_means)

# 3. Visualize distribution
df_all <- data.frame(Intensity = flattened_means)

# Histogram
ggplot(df_all, aes(x = Intensity)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.7) +
  labs(
    title = "Histogram of ALL Mean Intensities Across All Cells & m/z",
    x = "Mean Intensity",
    y = "Frequency"
  ) +
  theme_minimal(base_size = 14)

# Q-Q Plot
qqnorm(df_all$Intensity, main = "Q-Q Plot of All Mean Intensities")
qqline(df_all$Intensity, col = "red")

# Shapiro-Wilk
shapiro_test <- shapiro.test(df_all$Intensity)
print(paste("Shapiro-Wilk p-value =", shapiro_test$p.value))

# Skewness
skew_val <- skewness(df_all$Intensity, na.rm = TRUE)
print(paste("Skewness =", skew_val))

