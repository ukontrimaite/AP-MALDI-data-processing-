# Load necessary libraries
library(Cardinal)
library(viridis)
library(openxlsx)  # For writing to Excel
library(ggplot2)   # For plotting
library(moments)   # For skewness
library(nortest)   # For normality tests

# Load the file
path_processed <- "/correctpath/file_name.imzml"
print(path_processed)

# Load the processed imzML file
msa_peaks <- readMSIData(path_processed)
msa <- msa_peaks

# Data pre-processing - specifications can be changed as per individual experiment 
msa_pre <- normalize(msa, method="tic")
msa_pre <- reduceBaseline(msa_pre, method="locmin")
process(msa_pre)
msa_peaks <- peakPick(msa_pre, method="mad", SNR=5)
process(msa_peaks)
mse_peaks <- peakAlign(msa_peaks, tolerance=5, units="ppm")
mse <- mse_peaks

# Optional - Data pre-processing step 
mse_filt <- subsetFeatures(mse_peaks, freq > 0.1)
mse <- mse_filt

# ----------------------------
# ROI Extraction for x number of ROIs or Cells with selected m/z
# ----------------------------

# Extract the coordinates data frame
coords <- coord(mse)

# Create a list to store the ROI data
roi_list <- list()
all_intensities <- c()  # Store all intensities for histogram

# Loop to select and name 10 ROIs
for (i in 1:10) {
  roi_name <- paste("cell", i, sep = "_")
  sampleROI <- selectROI(mse, mz=159.124, mode="region")
  
  # Extract intensities and coordinates from the ROI
  roi_intensities <- intensity(mse)[, sampleROI]
  roi_coordinates <- coord(mse)[sampleROI, ]
  
  # Compute mean intensities for each m/z across extracted pixels
  mean_intensities <- rowMeans(roi_intensities, na.rm = TRUE)
  
  # Create a data frame with m/z and mean intensities
  roi_data <- data.frame(mz = mz(mse), Mean_Intensity = mean_intensities)
  names(roi_data)[2] <- roi_name  # Rename column to reflect cell name
  
  # Store data in the list
  roi_list[[roi_name]] <- roi_data
}

# Combine all cell data frames into a single data frame
combined_roi_data <- Reduce(function(x, y) merge(x, y, by = "mz", all = TRUE), roi_list)

# Save the combined data frame as an Excel file
output_excel_file <- "~/Documents/file_name.xlsx"
write.xlsx(combined_roi_data, file = output_excel_file, rowNames = FALSE)
print(paste("Excel file saved at:", output_excel_file))

# ----------------------------
# Image generation
# ----------------------------

# mz=input your desired mz, zlim function allows you to select your own intensity threshold, if wanted to use it
# Add a line zlim = c(0,150), meaning 150 is highest intensity in the threshold bar
# If you want to generate more than 1 mz image at a time copy/paste the following lines

# First m/z image generation
output_path <- "/Users/unek/Desktop/image_104.1065.png"
png(output_path, width = 800, height = 800)
image(mse_peaks, mz = 104.0748, col = viridis(100))
dev.off()


