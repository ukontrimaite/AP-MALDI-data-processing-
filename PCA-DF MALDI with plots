install.packages("pracma")  # If not installed
library(pracma)
library(ggplot2)

# Define file paths
data_path <- "/Users/unek/Desktop/PCA_df_global_SC_GlobalGIN_HA_combined_preprocessed_random_forest_mad5locmin_all copy.csv"
pca_output_path <- "/Users/unek/Desktop/pca_results.csv"
dfa_output_path <- "/Users/unek/Desktop/dfa_results_single_cell.csv"
pca_plot_path <- "/Users/unek/Desktop/pca_plot_single_cell.png"
dfa_plot_path <- "/Users/unek/Desktop/dfa_plot_single_cell.png"

# Load the dataset correctly
data <- read.csv(data_path, header = TRUE, stringsAsFactors = FALSE, check.names = FALSE)

# Separate labels and features
label <- as.factor(data[, 1])  # First column is the class label
features <- data.matrix(data[, -1])  # Convert features to a numeric matrix

#Perform transformation (please select appropriate according to normal distribution results or delete if not required)
features <- log10(features + 1)  # Log transformation
features <- scale(features, center = TRUE, scale = sqrt(apply(features, 2, sd))) # Pareto scaling

# Perform PCA
pca_results <- prcomp(features, center = FALSE, scale. = FALSE)

# Calculate variance explained by each PC
pca_variance <- pca_results$sdev^2
pca_variance_ratio <- (pca_variance / sum(pca_variance)) * 100
print(pca_variance_ratio)

# Extract PCA scores
pca_scores <- data.frame(PC1 = pca_results$x[, 1], PC2 = pca_results$x[, 2], Class = label)

# Save PCA results
write.csv(pca_results$x, pca_output_path, row.names = TRUE)

# Plot PCA results
p <- ggplot(pca_scores, aes(x = PC1, y = PC2, color = Class)) +
  geom_point(size = 3) +
  theme_minimal() +
  labs(title = "PCA Plot of Metabolomic Data",
       x = paste("Principal Component 1 (PC1) -", pca_variance_ratio[1], "% Variance"),
       y = paste("Principal Component 2 (PC2) -", pca_variance_ratio[2], "% Variance"))
print(p)
ggsave(pca_plot_path, plot = p, width = 8, height = 6)

# Save PCA scores plot
write.csv(pca_scores, "/Users/unek/Desktop/pca_scores.csv", row.names = TRUE)

# Define groups to include in DFA
selected_groups <- c("GIN", "HA")  # Change these as needed

# Filter data to include only selected groups
filtered_data <- data[data[, 1] %in% selected_groups, ]
filtered_label <- as.factor(filtered_data[, 1])  # Extract class labels
filtered_features <- data.matrix(filtered_data[, -1])  # Extract features

# Define the DFA function
pcdfa <- function(x, label, no_pc = 10, maxfac = NULL) {
  unique_label <- unique(label)
  no_class <- length(unique_label)
  if (no_class < 2) stop("Number of classes must be > 1")
  if (is.null(maxfac) || maxfac > no_class - 1) {
    maxfac <- no_class - 1
  }
  
  xmean <- colMeans(x)
  pca_results <- prcomp(x)
  x <- pca_results$x[, 1:no_pc]
  pc_loadings <- pca_results$rotation[, 1:no_pc]
  
  mx <- colMeans(x)
  Tt <- matrix(0, ncol(x), ncol(x))
  W <- matrix(0, ncol(x), ncol(x))
  
  for (i in unique_label) {
    K <- x[label == i, ]
    ns <- nrow(K)
    zz <- if (ns > 1) colMeans(K) else K
    A <- K - matrix(mx, nrow = ns, ncol = ncol(K), byrow = TRUE)
    C <- K - matrix(zz, nrow = ns, ncol = ncol(K), byrow = TRUE)
    Tt <- Tt + t(A) %*% A
    W <- W + t(C) %*% C
  }
  
  B <- Tt - W
  invW <- solve(W)
  P <- invW %*% B
  P_eigen <- eigen(P)
  V <- Re(P_eigen$vectors[, 1:maxfac])
  U <- x %*% V
  loadings <- pc_loadings %*% V
  
  return(list(scores = U, loadings = loadings, eigenvalues = P_eigen$values, xmean = xmean))
}

# Perform DFA only on selected groups
dfa_results <- pcdfa(filtered_features, label = filtered_label, no_pc = 10, maxfac = NULL)

# Save DFA results
write.csv(dfa_results$scores, dfa_output_path, row.names = TRUE)

# Save DFA results
write.csv(dfa_results$scores, dfa_output_path, row.names = TRUE)
write.csv(dfa_results$loadings, "/Users/unek/Desktop/dfa_loadings_gin_ha.csv", row.names = TRUE)  # Added line

cat("PCA and DFA results for selected groups saved successfully.")

# -------------------------------
# PCA Plot: Volcano-Style Aesthetic
# -------------------------------
# Load required packages
library(ggplot2)
library(scales)
library(ggthemes)

# Load data
pca_scores <- read.csv("/Users/unek/Desktop/pca_scores.csv", stringsAsFactors = FALSE)

# Round PC scores
pca_scores$PC1 <- round(pca_scores$PC1, 2)
pca_scores$PC2 <- round(pca_scores$PC2, 2)

# Variance explained (insert your own values if needed)
pc1_var <- 28.39
pc2_var <- 24.06

# Clean PCA Plot
ggplot(pca_scores, aes(x = PC1, y = PC2, color = Class)) +
  geom_point(size = 3.5, alpha = 0.9) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray70", linewidth = 0.6) +  # faint center line
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray70", linewidth = 0.6) +  # faint center line
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(
    breaks = pretty_breaks(n = 5),
    labels = number_format(accuracy = 0.01)
  ) +
  scale_y_continuous(
    breaks = pretty_breaks(n = 5),
    labels = number_format(accuracy = 0.01)
  ) +
  theme_classic(base_size = 16) +
  theme(
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.6),
    axis.line = element_blank(),
    legend.title = element_blank(),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    legend.position = "right"
  ) +
  labs(
    title = NULL,
    x = paste0("PC1 (", round(pc1_var, 2), "%)"),
    y = paste0("PC2 (", round(pc2_var, 2), "%)")
  )

# Save plot
ggsave("/Users/unek/Desktop/PCA_plot_final.png", width = 8, height = 6)

cat("✅ Final PCA plot saved: 'PCA_plot_final.png")

# Load required packages
library(ggplot2)
library(scales)
library(ggthemes)

# Load data
pca_scores <- read.csv("/Users/unek/Desktop/pca_scores.csv", stringsAsFactors = FALSE)

# Round PC scores
pca_scores$PC1 <- round(pca_scores$PC1, 2)
pca_scores$PC2 <- round(pca_scores$PC2, 2)

# Variance explained (edit as needed)
pc1_var <- 28.39
pc2_var <- 24.06

# PCA Plot with 95% CI ellipses
ggplot(pca_scores, aes(x = PC1, y = PC2, color = Class)) +
  geom_point(size = 3.5, alpha = 0.9) +
  stat_ellipse(type = "norm", level = 0.95, linewidth = 0.8, linetype = "solid", alpha = 0.15) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray70", linewidth = 0.6) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray70", linewidth = 0.6) +
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(
    breaks = pretty_breaks(n = 5),
    labels = number_format(accuracy = 0.01)
  ) +
  scale_y_continuous(
    breaks = pretty_breaks(n = 5),
    labels = number_format(accuracy = 0.01)
  ) +
  theme_classic(base_size = 16) +
  theme(
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.6),
    axis.line = element_blank(),
    legend.title = element_blank(),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    legend.position = "right"
  ) +
  labs(
    title = NULL,
    x = paste0("PC1 (", round(pc1_var, 2), "%)"),
    y = paste0("PC2 (", round(pc2_var, 2), "%)")
  )

# Save to file
ggsave("/Users/unek/Desktop/PCA_plot_with_95CI.png", width = 8, height = 6)

cat("✅ PCA plot with 95% confidence ellipses saved: 'PCA_plot_with_95CI.pdf'")

# -------------------------------
# PCA Plot with Filled 95% CI Ellipses
# -------------------------------

# Load necessary packages
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("scales")) install.packages("scales")
if (!require("ggthemes")) install.packages("ggthemes")
if (!require("ggrepel")) install.packages("ggrepel")  # optional for labels
library(ggplot2)
library(scales)
library(ggthemes)
library(ggrepel)

# ---- Load PCA scores ----
pca_scores <- read.csv("/Users/unek/Desktop/pca_scores.csv", stringsAsFactors = FALSE)

# ---- Round PC values ----
pca_scores$PC1 <- round(pca_scores$PC1, 2)
pca_scores$PC2 <- round(pca_scores$PC2, 2)

# ---- Variance Explained (edit based on your PCA object if needed) ----
pc1_var <- 28.39
pc2_var <- 24.06

# ---- Generate PCA Plot ----
ggplot(pca_scores, aes(x = PC1, y = PC2, color = Class)) +
  geom_point(size = 3.5, alpha = 0.9) +
  stat_ellipse(aes(fill = Class), type = "norm", level = 0.95,
               geom = "polygon", alpha = 0.2, color = NA) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray70", linewidth = 0.6) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray70", linewidth = 0.6) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  scale_x_continuous(
    breaks = pretty_breaks(n = 5),
    labels = number_format(accuracy = 0.01)
  ) +
  scale_y_continuous(
    breaks = pretty_breaks(n = 5),
    labels = number_format(accuracy = 0.01)
  ) +
  theme_classic(base_size = 16) +
  theme(
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.6),
    axis.line = element_blank(),
    legend.title = element_blank(),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    legend.position = "right"
  ) +
  labs(
    title = NULL,
    x = paste0("PC1 (", round(pc1_var, 2), "%)"),
    y = paste0("PC2 (", round(pc2_var, 2), "%)")
  )

# ---- Save to file ----
ggsave("/Users/unek/Desktop/PCA_plot_filled_ellipses.png", width = 8, height = 6)

cat("✅ PCA plot with filled 95% CI ellipses saved to Desktop.\n")

