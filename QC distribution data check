# Load necessary libraries
library(Cardinal)
library(viridis)
library(openxlsx)  # For writing to Excel
library(ggplot2)   # For plotting
library(moments)   # For skewness
library(nortest)   # For normality tests

# Load the file
path_processed <-"/Users/unek/Desktop/gin8_positive.imzml"
print(path_processed)

# Load the processed imzML file
msa_peaks <- readMSIData(path_processed)
msa <- msa_peaks

# Data pre-processing - no normalisation 
msa_pre <- reduceBaseline(msa, method="locmin")
process(msa_pre)
msa_peaks <- peakPick(msa_pre, method="mad", SNR=4)
process(msa_peaks)
mse_peaks <- peakAlign(msa_peaks, tolerance=5, units="ppm")
mse <- mse_peaks

# Optional - Data pre-processing step 
mse_filt <- subsetFeatures(mse_peaks, freq > 0.1)
mse <- mse_filt


# ----------------------------
# Normality Assessment (Raw Data)
# ----------------------------

# Sum across m/z rows to get one number per pixel
msi_matrix <- as.matrix(intensity(mse))
tic_values <- colSums(msi_matrix)

# Put into a data frame for ggplot
df_tic <- data.frame(TIC = tic_values)

# 1. Histogram of TIC
library(ggplot2)
ggplot(df_tic, aes(x = TIC)) +
  geom_histogram(bins = 30, fill = "blue", alpha = 0.6) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Histogram of Total Ion Current (Per Pixel)",
    x = "TIC (Summed Intensities)",
    y = "Count of Pixels"
  )

# 2. Q-Q Plot
qqnorm(df_tic$TIC, main = "Q-Q Plot: Total Ion Current")
qqline(df_tic$TIC, col = "red")

# 3. Basic Stats
summary(df_tic$TIC)  # Min, 1Q, Median, Mean, 3Q, Max
quantile(df_tic$TIC, probs = c(0.05, 0.95))  # 5th and 95th percentile, etc.

# 4. (Optional) Shapiro-Wilk for normality test
shapiro.test(df_tic$TIC)

all_values <- as.vector(msi_matrix)

# Histogram of all intensities
df_all <- data.frame(Intensity = all_values)
ggplot(df_all, aes(x = Intensity)) +
  geom_histogram(bins = 50, fill = "blue", alpha = 0.6) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Histogram of All Intensities",
    x = "Raw Intensity",
    y = "Count"
  )

# Q-Q Plot
qqnorm(df_all$Intensity, main = "Q-Q Plot: All Intensities")
qqline(df_all$Intensity, col = "red")

# Basic stats
summary(df_all$Intensity)
shapiro.test(df_all$Intensity)  # if feasible on large vector

