# Load necessary libraries
library(Cardinal)
library(viridis)
library(openxlsx)  # For writing to Excel
library(ggplot2)   # For plotting
library(moments)   # For skewness
library(nortest)   # For normality tests

# Load the file
path_processed <- "/correctpath/file.imzml"
print(path_processed)

# Load the processed imzML file
msa_peaks <- readMSIData(path_processed)
msa <- msa_peaks

# Data pre-processing - specifications can be changed as per individual experiment 
msa_pre <- normalize(msa, method="tic")
msa_pre <- reduceBaseline(msa_pre, method="locmin")
process(msa_pre)
msa_peaks <- peakPick(msa_pre, method="mad", SNR=5)
process(msa_peaks)
mse_peaks <- peakAlign(msa_peaks, tolerance=5, units="ppm")
mse <- mse_peaks

# Optional - Data pre-processing step 
mse_filt <- subsetFeatures(mse_peaks, freq > 0.1)
mse <- mse_filt

# ----------------------------
# Image generation
# ----------------------------

# mz=input your desired mz, zlim function allows you to select your own intensity threshold, if wanted to use it
# Add a line zlim = c(0,150), meaning 150 is highest intensity in the threshold bar
# If you want to generate more than 1 mz image at a time copy/paste the following lines

# First m/z image generation
output_path <- "/Users/unek/Desktop/image_104.1065.png"
png(output_path, width = 800, height = 800)
image(mse_peaks, mz = 104.0748, col = viridis(100))
dev.off()

